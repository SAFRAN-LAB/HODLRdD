\doxysection{cereal\+::memory\+\_\+detail\+::Enable\+Shared\+State\+Helper\texorpdfstring{$<$}{<} T \texorpdfstring{$>$}{>} Class Template Reference}
\hypertarget{classcereal_1_1memory__detail_1_1_enable_shared_state_helper}{}\label{classcereal_1_1memory__detail_1_1_enable_shared_state_helper}\index{cereal::memory\_detail::EnableSharedStateHelper$<$ T $>$@{cereal::memory\_detail::EnableSharedStateHelper$<$ T $>$}}


{\ttfamily \#include $<$memory.\+hpp$>$}

\doxysubsubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classcereal_1_1memory__detail_1_1_enable_shared_state_helper_a7358952ac850c005295f899a5aa3b184}{Enable\+Shared\+State\+Helper}} (T \texorpdfstring{$\ast$}{*}ptr)
\begin{DoxyCompactList}\small\item\em Saves the state of some type inheriting from enable\+\_\+shared\+\_\+from\+\_\+this. \end{DoxyCompactList}\item 
\Hypertarget{classcereal_1_1memory__detail_1_1_enable_shared_state_helper_ae9cd690a665f3c864b6963f9b69b64cf}\label{classcereal_1_1memory__detail_1_1_enable_shared_state_helper_ae9cd690a665f3c864b6963f9b69b64cf} 
void {\bfseries restore} ()
\begin{DoxyCompactList}\small\item\em Restores the state of the held pointer (can only be done once) \end{DoxyCompactList}\item 
\Hypertarget{classcereal_1_1memory__detail_1_1_enable_shared_state_helper_a33651283607ae0b7cf4eb7918931a98a}\label{classcereal_1_1memory__detail_1_1_enable_shared_state_helper_a33651283607ae0b7cf4eb7918931a98a} 
{\bfseries \texorpdfstring{$\sim$}{\string~}\+Enable\+Shared\+State\+Helper} ()
\begin{DoxyCompactList}\small\item\em Restores the state of the held pointer if not done previously. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\subsubsection*{template$<$class T$>$\newline
class cereal\+::memory\+\_\+detail\+::\+Enable\+Shared\+State\+Helper$<$ T $>$}
A helper struct for saving and restoring the state of types that derive from std\+::enable\+\_\+shared\+\_\+from\+\_\+this

This special struct is necessary because when a user uses load\+\_\+and\+\_\+construct, the weak\+\_\+ptr (or whatever implementation defined variant) that allows enable\+\_\+shared\+\_\+from\+\_\+this to function correctly will not be initialized properly.

This internal weak\+\_\+ptr can also be modified by the shared\+\_\+ptr that is created during the serialization of a polymorphic pointer, where cereal creates a wrapper shared\+\_\+ptr out of a void pointer to the real data.

In the case of load\+\_\+and\+\_\+construct, this happens because it is the allocation of shared\+\_\+ptr that perform this initialization, which we let happen on a buffer of memory (aligned\+\_\+storage). This buffer is then used for placement new later on, effectively overwriting any initialized weak\+\_\+ptr with a default initialized one, eventually leading to issues when the user calls shared\+\_\+from\+\_\+this.

To get around these issues, we will store the memory for the enable\+\_\+shared\+\_\+from\+\_\+this portion of the class and replace it after whatever happens to modify it (e.\+g. the user performing construction or the wrapper shared\+\_\+ptr in saving).

Note that this goes into undefined behavior territory, but as of the initial writing of this, all standard library implementations of std\+::enable\+\_\+shared\+\_\+from\+\_\+this are compatible with this memory manipulation. It is entirely possible that this may someday break or may not work with convoluted use cases.

Example usage\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{T\ *\ myActualPointer;}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \mbox{\hyperlink{classcereal_1_1memory__detail_1_1_enable_shared_state_helper_a7358952ac850c005295f899a5aa3b184}{EnableSharedStateHelper<T>}}\ helper(\ myActualPointer\ );\ \textcolor{comment}{//\ save\ the\ state}}
\DoxyCodeLine{\ \ std::shared\_ptr<T>\ myPtr(\ myActualPointer\ );\ \textcolor{comment}{//\ modifies\ the\ internal\ weak\_ptr}}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ helper\ restores\ state\ when\ it\ goes\ out\ of\ scope}}
\DoxyCodeLine{\}}

\end{DoxyCode}


When possible, this is designed to be used in an RAII fashion -\/ it will save state on construction and restore it on destruction. The restore can be done at an earlier time (e.\+g. after construct() is called in load\+\_\+and\+\_\+construct) in which case the destructor will do nothing. Performing the restore immediately following construct() allows a user to call shared\+\_\+from\+\_\+this within their load\+\_\+and\+\_\+construct function.


\begin{DoxyTemplParams}{Template Parameters}
{\em T} & \doxylink{rapidjson_8h_a1d1cfd8ffb84e947f82999c682b666a7}{Type} pointed to by shared\+\_\+ptr \\
\hline
\end{DoxyTemplParams}


\label{doc-constructors}
\Hypertarget{classcereal_1_1memory__detail_1_1_enable_shared_state_helper_doc-constructors}
\doxysubsection{Constructor \& Destructor Documentation}
\Hypertarget{classcereal_1_1memory__detail_1_1_enable_shared_state_helper_a7358952ac850c005295f899a5aa3b184}\index{cereal::memory\_detail::EnableSharedStateHelper$<$ T $>$@{cereal::memory\_detail::EnableSharedStateHelper$<$ T $>$}!EnableSharedStateHelper@{EnableSharedStateHelper}}
\index{EnableSharedStateHelper@{EnableSharedStateHelper}!cereal::memory\_detail::EnableSharedStateHelper$<$ T $>$@{cereal::memory\_detail::EnableSharedStateHelper$<$ T $>$}}
\doxysubsubsection{\texorpdfstring{EnableSharedStateHelper()}{EnableSharedStateHelper()}}
{\footnotesize\ttfamily \label{classcereal_1_1memory__detail_1_1_enable_shared_state_helper_a7358952ac850c005295f899a5aa3b184} 
template$<$class T$>$ \\
\mbox{\hyperlink{classcereal_1_1memory__detail_1_1_enable_shared_state_helper}{cereal\+::memory\+\_\+detail\+::\+Enable\+Shared\+State\+Helper}}$<$ T $>$\+::\+Enable\+Shared\+State\+Helper (\begin{DoxyParamCaption}\item[{T \texorpdfstring{$\ast$}{*}}]{ptr}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}



Saves the state of some type inheriting from enable\+\_\+shared\+\_\+from\+\_\+this. 


\begin{DoxyParams}{Parameters}
{\em ptr} & The raw pointer held by the shared\+\_\+ptr \\
\hline
\end{DoxyParams}


The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
lib/cereal/types/\mbox{\hyperlink{memory_8hpp}{memory.\+hpp}}\end{DoxyCompactItemize}
